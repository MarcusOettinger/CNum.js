function CNum(expr){var _margin=50;var X_C=100,Y_C=100;var _plotW,_plotH;var _SCALE=10;var _maxradius=1;var _tickLength=3;var _daCanvas=null;var _dactx=null;var _TICKSCALE=0.001;var _defaults={clear:false,coords:false,Arrow:true,arrowAngle:45,arrowRadius:10,circle:false,ReIm:true,Ctext:true,arc:true,showDegree:false,showPiFractions:true,decimals:2,fontSize:"12px",fontFamily:"serif",color:"#888",linewidth:1};zStr=math.eval(expr);this.zNum=math.complex(zStr);this.x=math.round(this.zNum.re,3);this.y=math.round(this.zNum.im,3);this.offsetx=0;this.offsety=0;var _radius=this.zNum.toPolar().r;var _a=this.zNum.toPolar().phi;this.angle=_a<0?2*Math.PI+_a:_a;this._daSettings=_defaults;var _numlist=[];_count=1;function _XScaled(x){return _SCALE*x}function _YScaled(y){return _SCALE*y}function _XPos(x){return X_C+_XScaled(x)}function _YPos(y){return Y_C-_YScaled(y)}function sign(x){return typeof x==="number"?x?x<0?-1:1:x===x?0:NaN:NaN}function min(a,b){return b<a?b:a}function max(a,b){return b>a?b:a}function _getmaxRadius(){var ret=_radius;for(var i=0;i<_numlist.length;i++){ret=max(ret,(_numlist[i].GetRadius()))}return ret}function endsWith(input,search){var index=input.length-search.length;return index>=0&&input.indexOf(search,index)>-1}function _formatAngle(angle,showDegree,showPiFractions,decimals){return showDegree?(math.round((angle*360)/(2*Math.PI),decimals)+"°"):showPiFractions?math.round(angle/Math.PI,decimals)+"π":math.round(angle,decimals)}function _setFont(ctx,params){var str=params.fontSize;if(endsWith(str,"px")==false){while(isNaN(str)&&str.length>1){str=str.substring(0,str.length-1)}str=str+"px"}ctx.font=str+" "+params.fontFamily}function extend(){for(var i=1;i<arguments.length;i++){for(var key in arguments[i]){if(arguments[i].hasOwnProperty(key)){arguments[0][key]=arguments[i][key]}}}return arguments[0]}function _clearCanvas(){if(_dactx==null){return}_dactx.clearRect(0,0,_daCanvas.width,_daCanvas.height);_count=0}function _addArrow(ctx,params,x1,y1,x2,y2){var leftX,leftY,rightX,rightY,offsetX,offsetY,atan2=Math.atan2,PI=Math.PI,round=Math.round,abs=Math.abs,sin=Math.sin,cos=Math.cos,angle;if(params.arrowRadius){angle=atan2((y2-y1),(x2-x1));angle-=PI;offsetX=(params.linewidth*cos(angle))-1;offsetY=(params.linewidth*sin(angle))-1;leftX=x2-(params.arrowRadius*cos(angle+(params.arrowAngle/2)));leftY=y2-(params.arrowRadius*sin(angle+(params.arrowAngle/2)));rightX=x2-(params.arrowRadius*cos(angle-(params.arrowAngle/2)));rightY=y2-(params.arrowRadius*sin(angle-(params.arrowAngle/2)));ctx.moveTo(leftX-offsetX,leftY-offsetY);ctx.lineTo(x2-offsetX,y2-offsetY);ctx.lineTo(rightX-offsetX,rightY-offsetY);ctx.closePath();ctx.fill();ctx.moveTo(x2-offsetX,y2-offsetY);ctx.lineTo(x2+offsetX,y2+offsetY);ctx.moveTo(x2,y2)}}function _drawLine(params,options){if(_dactx==null){return}var settings=extend({},params,options);_dactx.strokeStyle=settings.color;_dactx.fillStyle=settings.color;_dactx.lineWidth=settings.linewidth;_dactx.beginPath();_dactx.moveTo(settings.x1,settings.y1);_dactx.lineTo(settings.x2,settings.y2);if(settings.endArrow){_addArrow(_dactx,settings,settings.x1,settings.y1,settings.x2,settings.y2)}if(settings.startArrow){_addArrow(_dactx,settings,settings.x2,settings.y2,settings.x1,settings.y1)}_dactx.stroke()}function _drawText(params,options){if(_dactx==null){return}var settings=extend({},params,options);_dactx.beginPath();_dactx.strokeStyle=settings.color;_dactx.lineWidth=settings.linewidth;_dactx.fillStyle=settings.color;_setFont(_dactx,settings);_dactx.textAlign="center";_dactx.textBaseline="middle";_dactx.fillText(settings.text,settings.x,settings.y)}function _drawRect(options){if(_dactx==null){return}var settings=extend({},this._daSettings,options);_dactx.beginPath();_dactx.strokeStyle=settings.color;_dactx.lineWidth=settings.linewidth;_dactx.rect(settings.x,settings.y,settings.width,settings.height);_dactx.stroke()}function _drawArc(z,options){if(_dactx==null){return}var settings=extend({},z.GetSettings(),options);var counterclockwise=true;_dactx.beginPath();_dactx.strokeStyle=settings.color;_dactx.lineWidth=settings.linewidth;_dactx.arc(settings.x,settings.y,settings.radius,settings.start,-settings.end,counterclockwise);_dactx.stroke()}function _setScale(maxradius){X_C=_daCanvas.width/2;Y_C=_daCanvas.height/2;_plotW=_daCanvas.width-2*_margin;_plotH=_daCanvas.height-2*_margin;_SCALE=min(_plotW,_plotH)/(2*maxradius);_maxradius=maxradius;while(maxradius/_TICKSCALE>10){_TICKSCALE=_TICKSCALE*10}if(_TICKSCALE>10){_TICKSCALE=_TICKSCALE*2}}function _drawtick(settings,pos){_drawLine(settings,{x1:_XPos(pos),y1:Y_C,x2:_XPos(pos),y2:Y_C+_tickLength});_drawText(settings,{x:_XPos(pos),y:Y_C+10,text:pos});_drawLine(settings,{x1:X_C,y1:_YPos(pos),x2:X_C-_tickLength,y2:_YPos(pos)});_drawText(settings,{x:X_C-20,y:_YPos(pos)+3,text:pos})}function _axes(settings){if(_daCanvas==null){return}var rec_w=_dactx.measureText("Re(z)").width+10;var rec_h=parseInt(_dactx.font.match(/\d+/),10);_drawLine(settings,{endArrow:true,x1:_margin,y1:Y_C,x2:_plotW+_margin,y2:Y_C});_drawText(settings,{x:_plotW+2*_margin-rec_w/2,y:Y_C,text:"Re(z)"});_drawText(settings,{x:X_C,y:_margin/2,text:"Im(z)"});_drawLine(settings,{endArrow:true,x1:X_C,y1:_plotH+_margin,x2:X_C,y2:_margin});for(i=_TICKSCALE;i<=_maxradius;i+=_TICKSCALE){_drawtick(settings,i)}}function _drawReIm(z,x,y){xpos=_XPos(x);ypos=_YPos(y);_drawLine(z.GetSettings(),{x1:xpos,y1:Y_C,x2:xpos,y2:ypos});_drawLine(z.GetSettings(),{x1:X_C,y1:ypos,x2:xpos,y2:ypos})}function drawz(z){xpos=_XPos(z.x+z.offsetx);ypos=_YPos(z.y+z.offsety);x=_XScaled(z.offsetx);y=_YScaled(z.offsety);corr=z.offsetx>0?15:0;var settings=z.GetSettings();if(settings.Arrow){_drawLine(settings,{endArrow:true,x1:X_C+x,y1:Y_C-y,x2:xpos,y2:ypos})}else{_drawRect({x:xpos-2,y:ypos-2,width:4,height:4})}if(typeof(settings.Ctext)!=="undefined"&&settings.Ctext!==false&&settings.Ctext!==null){var tstr="";if(typeof(settings.Ctext)==="boolean"&&settings.Ctext==true){tstr="z ="+math.complex(z.x,z.y).toString()}else{tstr=settings.Ctext}_drawText(settings,{x:xpos+10+corr,y:ypos-(sign(z.y)*10),text:tstr})}}function _drawAngle(z,angle){var PI=Math.PI;if(_daCanvas==null){return}var ra=min(50,(this._radius*_SCALE)/2);ra+=_count*2;_drawArc(z,{x:X_C,y:Y_C,radius:ra,start:0,end:angle});tx=X_C+(ra-10)*math.cos(angle-PI/6);ty=Y_C-(ra-10)*math.sin(angle-PI/6);_drawText(z.GetSettings(),{x:tx,y:ty,text:_formatAngle(angle,z.GetSettings().showDegree,z.GetSettings().showPiFractions,z.GetSettings().decimals)})}function _circ(z){var PI=Math.PI;if(_daCanvas==null){return}_drawArc(z,{x:X_C,y:Y_C,radius:(z.GetRadius()*_SCALE),start:0,end:2*PI})}this.GetRadius=function(){return _radius};this.GetSettings=function(){return this._daSettings};this.SetSettings=function(newsettings){var s=this.GetSettings();this._daSettings=extend({},s,newsettings);return this._daSettings};this.ToCartesian=function(){var d=typeof decimals=="undefined"?this._daSettings.decimals:decimals;return this.zNum.format(d)};this.ToCC=function(decimals){var d=typeof decimals=="undefined"?this._daSettings.decimals:decimals;return math.conj(this.zNum).format(d)};this.ToR=function(decimals){var d=typeof decimals=="undefined"?this._daSettings.decimals:decimals;return math.round(this.zNum.toPolar().r,d)};this.ToTrigonometric=function(decimals){var d=typeof decimals=="undefined"?this._daSettings.decimals:decimals;var r=math.round(this.zNum.toPolar().r,d);var phi=this.zNum.toPolar().phi;phi=_formatAngle(phi,this._daSettings.showDegree,this._daSettings.showPiFractions,d);retval=r+" &middot;(cos("+phi+") + i &middot;sin("+phi+"))";return retval};this.ToPolar=function(decimals){var d=typeof decimals=="undefined"?this._daSettings.decimals:decimals;var r=math.round(this.zNum.toPolar().r,d);var phi=this.zNum.toPolar().phi;phi=_formatAngle(phi,this._daSettings.showDegree,this._daSettings.showPiFractions,d);retval=r+"&middot; e<sup>i "+phi+"</sup>";return retval};this.setCanvas=function(cnv){_daCanvas=cnv;_dactx=(cnv)?cnv.getContext("2d"):null;return cnv};this.getCanvasImage=function(type){if(_daCanvas.toDataURL){quality=1;dataURL=_daCanvas.toDataURL("image/"+type,quality)}else{console.log("No toDataURL? Bummer!")}return dataURL};this.getXPos=function(x){return _XPos(x)};this.getYPos=function(y){return _YPos(y)};this.multiplyCNum=function(z2,options,resultoptions){var settings=extend({},_defaults,options,{circle:false});resultoptions=(typeof resultoptions=="undefined"?settings:extend({},_defaults,resultoptions));res=new CNum(math.multiply(this.zNum,z2.zNum).toString());z2.offsetx=0;z2.offsety=0;this.addToPlot(z2,settings);this.addToPlot(res,resultoptions);this.displayGauss(this.GetSettings());return res};this.addCNum=function(_zToAdd,options,resultoptions){var settings=extend({},_defaults,options,{circle:false,arc:false,ReIm:false});resultoptions=(typeof resultoptions=="undefined"?settings:extend({},_defaults,resultoptions));res=new CNum(this.zNum.toString()+"+"+_zToAdd.zNum.toString());this.addToPlot(res,resultoptions);_zToAdd.offsetx=this.x;_zToAdd.offsety=this.y;this.addToPlot(_zToAdd,settings);this.displayGauss(this.GetSettings());return res};this._drawToPlot=function(z){var s=z.GetSettings();if(s.circle){_circ(z)}if(s.arc){_drawAngle(z,z.angle)}if(s.ReIm){_drawReIm(z,z.x,z.y)}drawz(z)};this.addToPlot=function(z,options){var s=extend({},_defaults,options);z.SetSettings(s);if(z!==this){_numlist.push(z)}this._drawToPlot(z)};this.displayGauss=function(options,radius){var settings=extend({},_defaults,{clear:true,coords:true,circle:true},options);var maxR=typeof radius=="undefined"?_getmaxRadius():radius;_setScale(maxR);_clearCanvas();_axes(settings);this.addToPlot(this,settings);for(var i=0;i<_numlist.length;i++){this._drawToPlot(_numlist[i])}};return this};